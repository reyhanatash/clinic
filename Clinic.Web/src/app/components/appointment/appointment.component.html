<div class="appContainer">
  <div class="col-12 text-right">
    <h4> وقت دهی</h4>
  </div>
  <hr>
  <div *ngIf="checkAccess(1)" class="row px-0 d-lg-flex">
    <div class="col-12 d-flex">
      <div class="col-lg-4 col-12  p-2">
        <p-dropdown [options]="clinicsList" [(ngModel)]="selectedClinic" optionLabel="name"
          class="full-width text-right" (onChange)="getAppointment(appointmentDate)" />
      </div>
      <div *ngIf="userType != 9" class="col-lg-8 col-12 p-2">
        <p-multiSelect [options]="doctorList" optionLabel="name" dataKey="code" [(ngModel)]="selectedDoctorList"
          [ngModelOptions]="{standalone: true}" defaultLabel="پزشک" (ngModelChange)="getDetailOfDoctore()"
          class="full-width text-right">
        </p-multiSelect>
      </div>
    </div>
    <div class="col-lg-2 col-12 pr-2 my-2">
      <div class="mt-md-0 mt-3">
        <div class="mt-3">
          <div id="appointment" class="test-cal">
            <ng-persian-datepicker [uiIsVisible]="isCalendarVisible" [uiHideOnOutsideClick]="false">
              <input type="text" class="form-control d-none" [formControl]="firstCalendarDateNew" />
            </ng-persian-datepicker>
          </div>
        </div>
        <div class="mt-3">
          <div id="appointment" class="test-cal">
            <ng-persian-datepicker [uiIsVisible]="isCalendar2Visible" [uiHideOnOutsideClick]="false"
              (dateOnSelect)="changeSecondDate()">
              <input type="text" class="form-control d-none" [formControl]="secondCalendarDateNew" />
            </ng-persian-datepicker>
          </div>
        </div>
        <div class="col-12 p-0 mt-2 text-right">
          <div>برو به</div>
          <div class="date-navigator col-12 d-flex justify-content-center align-items-center p-0">
            <div class="col-4 p-2 text-center pointer" (click)="changeDate(14)">2</div>
            <div class="col-4 p-2 text-center pointer" (click)="changeDate(28)">4</div>
            <div class="col-4 p-2 text-center pointer" (click)="changeDate(42)">6</div>
          </div>
          <div>هفته بعد</div>
          <div class="date-navigator mt-3 col-12 d-flex justify-content-center align-items-center p-0">
            <div class="col-4 p-2 text-center pointer" (click)="changeDate(90)">3</div>
            <div class="col-4 p-2 text-center pointer" (click)="changeDate(180)">6</div>
            <div class="col-4 p-2 text-center pointer" (click)="changeDate(365)">12</div>
          </div>
          <div>ماه بعد</div>
        </div>
      </div>
    </div>
    <div class="col-lg-10 col-12 px-0 my-2">
      <div class="card-style-date p-3">
        <div class="col-12">
          <div class="d-flex mode-selector p-0 my-2">
            <div class="ml-1 p-2 pointer text-center" [ngClass]="{  'selected-mode' :!weekMode}"
              (click)="weekMode = false; getDetailOfDoctore()">
              روزانه</div>
            <div class="mr-1 p-2 pointer text-center" [ngClass]="{  'selected-mode' :weekMode}" F
              (click)="weekMode = true; getDetailOfDoctore()">
              هفتگی</div>
          </div>
        </div>
        <div class="col-12 mt-3" *ngIf="!weekMode">
          <div class="d-lg-flex justify-content-between align-items-center mb-3">
            <div class="d-flex align-items-center pointer" (click)="changeDate(1)">
              <i class="fa fa-arrow-right mx-1" aria-hidden="true"></i>
              <p class="mb-0">روز بعد</p>
            </div>
            <div class="text-center">
              <h6 class="mb-0">{{appointmentDate| JustDate}}</h6>
            </div>
            <div class="d-flex align-items-center pointer" (click)="changeDate(-1)">
              <p class="mb-0">روز قبل</p>
              <i class="fa fa-arrow-left mx-1" aria-hidden="true"></i>
            </div>
          </div>
        </div>
        <div class="row">
          <!-- Daily mode -->
          <div *ngIf="!weekMode" class="table-scroll col-12">
            <table *ngIf="filteredHours.length > 0"
              class="table col-12 table-bordered border-0 text-center appointment-grid">
              <thead class="tr-sticky d-flex">
                <tr class=" w-100 d-flex">
                  <th class="table-time col-2">ساعت</th>
                  <!-- <th class="text-center currentDate-box-table col-10">
                  </th> -->
                  <th class="text-center currentDate-box-table col" *ngFor="let doctor of doctors">
                    {{ doctor.name }}
                  </th>
                </tr>
              </thead>
              <tbody class="d-flex flex-column">
                <tr class="d-flex" *ngFor="let time of filteredHours">
                  <td class="col-2 d-flex justify-content-center align-items-center">{{time.time}}
                  </td>
                  <td *ngFor="let doctor of doctors" (click)="setNewAppointment(time,doctor.id)"
                    class="col p-2 d-flex appointments-container"
                    [ngClass]="{'bg-muted text-secondary': isBeforeNow || (!isBeforeNow && timeIsBeforeNow(appointmentDate, time.time)), 'bg-not-in-schedule' : !time.isInSchedule}">
                    <div *ngFor="let appointment of timeSheetData[time.time]"
                      class="appointment text-right px-2 pt-3 pb-1 mx-2 pointer"
                      [ngClass]="{'d-none': appointment.practitionerId !=doctor.id}"
                      [ngStyle]="{'background-color': appointment.color != null ? appointment.color : '#63C7B2'}">
                      <i class="fa fa-times" (click)="cancelAppointment(appointment.id)" aria-hidden="true"></i>
                      <div (click)="editAppointment(appointment)">
                        <!-- <div class="mt-2">نوع وقت : {{appointment.typeName}}</div> -->
                        <!-- <div class="mt-2"> {{appointment.doctorName}}</div> -->
                        <div class="mt-2 d-flex align-items-center">
                          <div class="badgee ml-2"
                            [ngClass]="{'bg-dark': appointment.status == 1,'bg-primary': appointment.status == 2,'bg-success': appointment.status == 3}">
                          </div>
                          {{appointment.patientName}}
                        </div>
                        <div class="mt-2"> {{appointment.note}}</div>
                        <!-- <div class="mt-2">کنسل <span *ngIf="appointment.cancelled">شده</span><span
                            *ngIf="!appointment.cancelled">نشده</span></div> -->

                      </div>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <!-- Weekly Mode -->
          <div *ngIf="weekMode" class="table-scroll col-12">
            <table class="table col-12 table-bordered border-0 text-center appointment-grid">
              <thead class="tr-sticky d-flex">
                <tr class="w-100 d-flex">
                  <th class="table-time col"></th>
                  <th *ngFor="let day of weekDays" class="text-center  bg-light col"
                    [ngClass]="{'today-bg': day.isToday, 'text-muted bg-muted': day.isPast}">
                    <div>{{day.dayName}}</div>
                    <div>{{day.dayNumber}}</div>
                  </th>
                </tr>
              </thead>
              <tbody class="d-flex flex-column">
                <tr class="d-flex" *ngFor="let time of hours; let rowIndex = index">
                  <td class="col d-flex justify-content-center align-items-center">{{time.time}}
                  </td>
                  <td *ngFor="let day of weeklyTimetable[time.time] " class="text-center col"
                    [ngClass]="{'today-bg': day.isToday, 'text-muted bg-muted': day.isPast ||(day.isToday && timeIsBeforeNow(day.fullDate, time.time)), 'bg-not-in-schedule' : !day.isInSchedule }">
                    <!-- (click)="setWeeklyNewAppointment(day.fullDate,time.time,day.isPast)" -->
                    <div *ngFor="let appointment of day.dayAppointments" [pTooltip]="appointment.note"
                      class="appointment text-right p-2 m-2 pointer"
                      [ngStyle]="{'background-color': appointment.color != null ? appointment.color : '#63C7B2'}">
                      <p class="mb-1"> {{appointment.practitionerName}}</p>
                      <p class="mb-0"> {{appointment.patientName}}</p>
                    </div>
                  </td>
                  <!-- <td class="col-10 p-2 d-flex appointments-container"
                                        (click)="setNewAppointment(time)">
                                        <div *ngFor="let appointment of timeSheetData[time]"
                                            class="appointment text-right p-2 pointer"
                                            (click)="editAppointment(appointment)">
                                            <div class="mt-2">نوع وقت : {{appointment.typeName}}</div>
                                            <div class="mt-2">نام بیمار : {{appointment.patientName}}</div>
                                            <div class="mt-2">توضیحات : {{appointment.note}}</div>
                                            <div class="mt-2">کنسل <span *ngIf="appointment.cancelled">شده</span><span
                                                    *ngIf="!appointment.cancelled">نشده</span></div>
                                        </div>
                                    </td> -->
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <p-dialog id="new-appointment-modal" header="اختصاص وقت به بیمار" [(visible)]="showNewAppointment" [closable]="true"
    [ngClass]="{'modalShadow' : showNewAppointment}" class="p-2">
    <div class="col-12 new-appointment-modal">
      <div class="col-12 text-right">
        <button *ngIf="!newAppointmentModel?.handelNewPateintStatus" class="btn btn-danger btn-sm"
          (click)="handelNewPateint(1)">ساخت بیمار جدید</button>
        <button *ngIf="newAppointmentModel?.handelNewPateintStatus" class="btn btn-danger btn-sm"
          (click)="handelNewPateint(2)">انصراف</button>
      </div>
      <div class=" col-12 d-flex justify-content-between mt-3">
        <div class="col-3 text-right">نوع وقت</div>
        <div class="col-9">
          <p-dropdown [options]="appointmentTypes" [(ngModel)]="newAppointmentModel.selectedType" optionLabel="name"
            placeholder="نوع وقت را انتخاب کنید" class="full-width text-right" />
        </div>
      </div>
      <div *ngIf="userType != 9" class=" col-12 d-flex justify-content-between mt-3">
        <div class="col-3 text-right"> نام دکتر</div>
        <div class="col-9">
          <p class="full-width text-right">
            {{ newAppointmentModel.selectedDoctorName }}
          </p>
        </div>
      </div>
      <div *ngIf="isServiceBase" class=" col-12 d-flex justify-content-between mt-3">
        <div class="col-3 text-right"> سرویس</div>
        <div class="col-9">
          <p-multiSelect [options]="serviceBaselist" optionLabel="name" dataKey="code"
            [(ngModel)]="newAppointmentModel.selectedService" [ngModelOptions]="{standalone: true}"
            class="full-width text-right">
          </p-multiSelect>
        </div>
      </div>
      <div *ngIf="!newAppointmentModel?.handelNewPateintStatus" class="col-12 d-flex justify-content-between mt-3">
        <div class="col-3 text-right">انتخاب بیمار</div>
        <div class="col-9">
          <div class="input-group">
            <input [(ngModel)]="searchControl" (keyup.enter)="getFilteredPatient()" type="text" class="form-control"
              placeholder="جستجوی نام یا شناسه" />
            <span class="input-group-btn">
              <button class="btn btn-default" type="button" (click)="getFilteredPatient()">
                <i class="fa fa-search"></i>
              </button>
            </span>
          </div>

          <ul class="dropdown-list" *ngIf="patientsList.length > 0 && dropdownOpen">
            <li [ngClass]="{'dropdown-selected': newAppointmentModel.selectedPatient == item.patientCode}"
              *ngFor="let item of patientsList" (click)="selectPatient(item)">{{
              item.name }}
              (ID: {{ item.id }})</li>
          </ul>

          <div *ngIf="selectedPatientName">
            <p class="mt-2 text-center">بیمار انتخاب‌ شده: {{ selectedPatientName }}</p>
          </div>

          <!-- <p *ngIf="searchControl && patientsList.length === 0">نتیجه‌ای یافت نشد</p> -->
          <!-- <p-dropdown [options]="patientsList" [(ngModel)]="newAppointmentModel.selectedPatient" optionLabel="name"
            placeholder="بیمار مورد نظر را انتخاب کنید" class="full-width text-right" /> -->
        </div>
      </div>
      <div *ngIf="newAppointmentModel?.handelNewPateintStatus">
        <div class="col-12 d-flex justify-content-between mt-3">
          <div class="col-3 text-right"> نام بیمار</div>
          <div class="col-9">
            <input type="text" name="firstName" [(ngModel)]="newPateint.firstName"
              placeholder="نام بیمار مورد نظر را وارد کنید" class="full-width form-control text-right" />
          </div>
        </div>
        <div class="col-12 d-flex justify-content-between mt-3">
          <div class="col-3 text-right"> نام‌خانوادگی بیمار</div>
          <div class="col-9">
            <input type="text" name="lastName" [(ngModel)]="newPateint.lastName"
              placeholder="نام‌خانوادگی بیمار مورد نظر را وارد کنید" class="full-width form-control  text-right" />
          </div>
        </div>
        <div class="col-12 d-flex justify-content-between mt-3">
          <div class="col-3 text-right"> شماره موبایل بیمار</div>
          <div class="col-9">
            <input type="text" name="mobile" [(ngModel)]="newPateint.mobile"
              placeholder="شماره موبایل بیمار مورد نظر را وارد کنید" class="full-width form-control  text-right" />
          </div>
        </div>
        <div class="col-12 text-center">
          <button class="btn btn-danger text-white px-3 py-1 mx-1" (click)="createPatient()">ذخیره</button>
        </div>
      </div>
      <hr>
      <div class="col-12 text-center mt-3">
        <div class="col-12 d-flex justify-content-between">
          <div class="col-4 text-right">تاریخ</div>
          <div class="col-8">{{newAppointmentModel.appointmentStartTime | JustDateZone}}</div>
        </div>
        <div class="col-12 d-flex justify-content-between mt-2">
          <div class="col-4 text-right">ساعت</div>
          <div class="col-4">از : {{newAppointmentModel.appointmentStartTime | ShamsiTime}}</div>
          <div class="col-4">تا : {{newAppointmentModel.appointmentEndTime | ShamsiTime}}</div>
        </div>
      </div>
      <hr>
      <div class="col-12 mt-3">
        <p class="text-right">یادداشت</p>
        <div>
          <textarea name="description" id="appointment-description" class="col-12"
            [(ngModel)]="newAppointmentModel.note"></textarea>
        </div>
      </div>
      <div class="col-12 d-flex justify-content-between my-3">
        <button class="btn btn-outline-success col-5" (click)="createAppointment()">ثبت</button>
        <button class="btn btn-outline-secondary col-5" (click)="closeNewAppointmentModal()">انصراف</button>
      </div>
    </div>
  </p-dialog>
</div>
